name: Secure SSH Access with tmate

on:
  workflow_dispatch:
    inputs:
      public_key:
        description: 'Your public SSH key'
        required: true

jobs:
  ssh-access:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Setup tmate session
        id: tmate
        uses: mxschmitt/action-tmate@v3

      - name: Authorize public key
        if: ${{ steps.tmate.outputs.tmate_success == 'true' }}
        run: |
          allowed_keys=$(cat << EOF
          ${{ secrets.ALLOWED_KEYS }}
          EOF
          )
          if [[ ! "$allowed_keys" =~ "${{ github.event.inputs.public_key }}" ]]; then
            echo "Public key not authorized"
            exit 1
          fi

      - name: Display SSH command
        if: ${{ steps.tmate.outputs.tmate_success == 'true' }}
        run: |
          echo "SSH command: ${{ steps.tmate.outputs.ssh_command }}"
